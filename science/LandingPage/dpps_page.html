<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DPP Generator | EduLens</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Inter", sans-serif;
        background: #f0f2f5;
        color: #111;
        padding: 2rem;
      }
      h1 { text-align: center; font-weight: 600; margin-bottom: 2rem; color: #1a1a1a; }
      .tabs { display:flex; justify-content:center; margin-bottom:1.5rem; }
      .tab {
        margin:0 1rem; padding:0.5rem 1.5rem; border-radius:10px; cursor:pointer;
        font-weight:600; color:#007aff; background:#fff; border:2px solid #007aff;
        transition: all 0.3s ease;
      }
      .tab.active { background:#007aff; color:white; }
      .form-container {
        display:flex; justify-content:center; gap:1rem; flex-wrap:wrap; margin-bottom:2rem;
      }
      .form-container input, .form-container select, .form-container button {
        padding:0.7rem 1.2rem; font-size:1rem; border-radius:14px; border:1px solid #ccc;
        backdrop-filter: blur(10px); background: rgba(255,255,255,0.6); transition: all 0.3s ease;
      }
      .form-container button { background:#007aff; color:white; font-weight:bold; border:none; }
      .form-container button:hover { background:#005ecc; }
      .summary-info { text-align:center; margin-bottom:1rem; font-size:1rem; color:#444; }
      .question-card {
        background:white; border-radius:18px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        padding:1.8rem 2rem; margin-bottom:1.8rem; transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .question-card:hover { transform: translateY(-4px); box-shadow:0 6px 25px rgba(0,0,0,0.1); }
      .question-number { font-size:1.3rem; font-weight:600; color:#333; margin-bottom:1rem; }
      .question-text { font-size:1.05rem; color:#444; }
      .answer-input { width:100%; margin-top:1rem; padding:0.7rem; font-size:1rem; border-radius:10px; border:1px solid #ccc; outline:none; }
      .submit-btn {
        margin-top:0.7rem; padding:0.6rem 1.2rem; background:#28a745; color:white; font-weight:600; border:none;
        border-radius:10px; cursor:pointer; transition: background 0.3s;
      }
      .submit-btn:hover { background:#218838; }
      .response-text { margin-top:0.6rem; font-size:1rem; font-weight:bold; color:#222; }
      details summary { cursor:pointer; font-weight:500; margin-top:1rem; color:#007aff; }

      /* locked / unlocked summary styles */
      details summary.locked-summary { pointer-events:none; color:#8c98a6; cursor:default; }
      details summary.unlocked-summary { pointer-events:auto; color:#007aff; cursor:pointer; }

      #historyContainer { display:none; }
      .history-entry {
        background: linear-gradient(135deg,#ffffff,#f8fcff); padding:1.3rem; border-radius:16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom:1.2rem; transition: transform 0.2s ease;
      }
      .history-entry:hover { transform: translateY(-3px); }
      .history-entry strong { display:block; font-size:1rem; color:#222; margin-bottom:0.3rem; }
      .history-entry small { color:#666; font-size:0.85rem; }
      .history-actions { margin-top:0.6rem; display:flex; gap:0.7rem; }
      .history-actions button { padding:0.5rem 1rem; font-size:0.9rem; font-weight:500; border-radius:8px; border:none; cursor:pointer; transition: background 0.2s; }
      .history-actions .resume { background:#007aff; color:white; }
      .history-actions .resume:hover { background:#0056cc; }
      .history-actions .delete { background:#dc3545; color:white; }
      .history-actions .delete:hover { background:#b52a38; }

      @media screen and (max-width:600px) {
        .form-container { flex-direction:column; align-items:center; }
        .form-container input, .form-container select, .form-container button { width:100%; }
      }
      /* other responsive rules omitted for brevity (kept above if you want) */
    </style>
  </head>
  <body>
    <h1>üî• DPP Generator</h1>
    <div class="tabs">
      <div class="tab active" onclick="showTab('generator')">üìö Generator</div>
      <div class="tab" onclick="showTab('history')">üìú History</div>
    </div>

    <div class="summary-info" id="summaryInfo">
      <strong>Class:</strong> ? | <strong>Subject:</strong> ? |
      <strong>Difficulty:</strong> <span id="summaryDifficulty">?</span> |
      <strong>Questions:</strong> 10
    </div>

    <!-- Generator Tab -->
    <div id="generatorContainer">
      <div class="form-container">
        <input type="text" id="topic" placeholder="Enter Topic" required />
        <select id="difficulty">
          <option value="">Select Difficulty (default is Medium)</option>
          <option value="Easy">Easy</option>
          <option value="Medium">Medium</option>
          <option value="Hard">Hard</option>
        </select>
        <button onclick="generateDPP()">Generate DPP</button>
      </div>
      <div id="questionContainer"></div>
    </div>

    <!-- History Tab -->
    <div id="historyContainer"><div id="historyList"></div></div>

    <script>
      const queryParams = (() => {
        const params = {};
        window.location.search
          .substring(1)
          .split("&")
          .forEach((pair) => {
            const [k, v] = pair.split("=");
            params[decodeURIComponent(k)] = decodeURIComponent(v || "");
          });
        return params;
      })();

      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("summaryInfo").innerHTML = `
          <strong>Class:</strong> ${queryParams.class || "?"} |
          <strong>Subject:</strong> ${queryParams.subject || "?"} |
          <strong>Difficulty:</strong> <span id="summaryDifficulty">${queryParams.difficulty || "?"}</span> |
          <strong>Questions:</strong> 10
        `;
        loadHistory();
      });

      async function generateDPP(topicParam, skipHistory = false) {
        const topic = topicParam || document.getElementById("topic").value;
        if (!topic) return alert("Please enter a topic.");

        // Use subject from the URL (user asked us to take it from link)
        const classVal = queryParams.class || "9";
        const subject = queryParams.subject || "Physics";

        const selectedDiff = document.getElementById("difficulty")?.value?.trim();
        const difficulty = selectedDiff || queryParams.difficulty || "Medium";

        const summaryDiff = document.getElementById("summaryDifficulty");
        if (summaryDiff) summaryDiff.textContent = difficulty;

        const count = 10;
        const container = document.getElementById("questionContainer");
        container.innerHTML = "<p>Loading questions...</p>";

        const prompt = `
          Generate a set of ${count} DPP questions for Class ${classVal} in ${subject}.
          The topic is "${topic}" with difficulty level "${difficulty}".
          Provide diverse questions and at the end, write: 'Answer Key and Explanations:' followed by the answers.
        `;

        // NOTE: You have your API keys here.
        const apiKey = "AIzaSyCrWe2hZRRmIlZaRLooSfmPrucRvAKugwc";
        const body = { contents: [{ parts: [{ text: prompt }] }] };

        try {
          const res = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            }
          );
          const data = await res.json();
          const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "No response from Gemini.";

          if (!skipHistory) {
            saveToHistory({ topic, classVal, difficulty, subject, text });
          }

          const questions = extractQuestions(text).slice(0, count);
          const answers = extractAnswers(text).slice(0, count);
          container.innerHTML = "";

          if (questions.length === 0) {
            container.innerHTML = "<p style='color:red'>‚ö†Ô∏è No questions found. Check API output.</p>";
            return;
          }

          questions.forEach((q, i) => {
            const card = document.createElement("div");
            card.className = "question-card";
            card.innerHTML = `
              <div class="question-number">Q${i + 1}.</div>
              <div class="question-text">${escapeHtml(q)}</div>
              <input class="answer-input" id="input-${i}" placeholder="Your answer here‚Ä¶">
              <button class="submit-btn" onclick="submitAnswer(${i})">Submit Answer</button>
              <div class="response-text" id="response-${i}"></div>
              <!-- locked details: summary will be disabled until user submits -->
              <details id="details-${i}">
                <summary class="locked-summary">Show Answer</summary>
                <p>${escapeHtml(answers[i] || "Answer not available")}</p>
              </details>
            `;
            container.appendChild(card);
          });
        } catch (err) {
          console.error(err);
          container.innerHTML = "<p style='color:red'>‚ùå Error contacting Gemini API.</p>";
        }
      }

      function extractQuestions(text) {
        return text
          .split("\n")
          .filter((l) => /^\d+[\.\)]\s+/.test(l.trim()))
          .map((l) => l.trim().replace(/^\d+[\.\)]\s+/, ""));
      }

      function extractAnswers(text) {
        const idx = text.indexOf("Answer Key and Explanations:");
        if (idx < 0) return [];
        return text
          .substring(idx)
          .split("\n")
          .filter((l) => /^\d+[\.\)]\s+/.test(l.trim()))
          .map((l) => l.trim().replace(/^\d+[\.\**)]\s+/, ""));
      }

      async function submitAnswer(idx) {
        const input = document.getElementById(`input-${idx}`);
        const response = document.getElementById(`response-${idx}`);
        const questionCards = document.querySelectorAll(".question-text");

        if (!input.value.trim()) {
          alert("Enter an answer.");
          return;
        }

        const userAnswer = input.value.trim();
        const question = questionCards[idx].innerText;

        const prompt = `
          Evaluate this answer.
          Question: ${question}
          Answer given by student: ${userAnswer}
          Respond with "Correct" or "Incorrect" followed by a brief explanation if possible.
        `;

        const apiKey = "AIzaSyCgYCSLZvMorx0n7jM0nnyq2CqANXJseLs";
        const body = { contents: [{ parts: [{ text: prompt }] }] };

        response.textContent = "‚è≥ Checking your answer...";

        try {
          const res = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            }
          );

          const data = await res.json();
          const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text || "‚ö†Ô∏è No response from Gemini.";
          response.textContent = reply;

          // unlock and open the details/dropdown for this question AFTER evaluation
          const det = document.getElementById(`details-${idx}`);
          if (det) {
            det.open = true;
            const summ = det.querySelector("summary");
            if (summ) { summ.classList.remove("locked-summary"); summ.classList.add("unlocked-summary"); }
          }
        } catch (err) {
          console.error(err);
          response.textContent = "‚ùå Error checking answer.";
          const det = document.getElementById(`details-${idx}`);
          if (det) {
            det.open = true;
            const summ = det.querySelector("summary");
            if (summ) { summ.classList.remove("locked-summary"); summ.classList.add("unlocked-summary"); }
          }
        }
      }

      function saveToHistory(item) {
        let hist = JSON.parse(localStorage.getItem("dppHistory") || "[]");
        hist.unshift({ ...item, date: new Date().toLocaleString() });
        localStorage.setItem("dppHistory", JSON.stringify(hist.slice(0, 20)));
      }

      // Delete using original array index so we remove the correct item
      function deleteHistory(originalIndex) {
        let hist = JSON.parse(localStorage.getItem("dppHistory") || "[]");
        if (originalIndex >= 0 && originalIndex < hist.length) {
          hist.splice(originalIndex, 1);
          localStorage.setItem("dppHistory", JSON.stringify(hist));
        }
        loadHistory();
      }

      // When resuming, restore topic & difficulty to UI, then generate (skip saving to history)
      function resumeHistory(originalIndex) {
        const hist = JSON.parse(localStorage.getItem("dppHistory") || "[]");
        const item = hist[originalIndex];
        if (!item) return alert("History item not found.");
        document.getElementById("topic").value = item.topic || "";
        const diffSelect = document.getElementById("difficulty");
        if (diffSelect && item.difficulty) {
          // try to set the difficulty select to stored value (case-insensitive)
          const val = Array.from(diffSelect.options).find(o => (o.value || "").toLowerCase() === (item.difficulty || "").toLowerCase());
          if (val) diffSelect.value = val.value;
        }
        // Optionally switch to generator tab
        showTab('generator');
        // Generate without saving to history (skipHistory = true)
        generateDPP(item.topic, true);
      }

      function loadHistory() {
        const hist = JSON.parse(localStorage.getItem("dppHistory") || "[]");
        const list = document.getElementById("historyList");
        list.innerHTML = "";

        // Get subject filter from URL (case-insensitive). If absent, show all.
        const subjectFilter = (queryParams.subject || "").trim().toLowerCase() || null;

        // Build filtered list but preserve original indices in storage
        const filtered = hist
          .map((item, idx) => ({ ...item, _origIdx: idx }))
          .filter((item) => {
            if (!subjectFilter) return true; // no filter -> show all
            return (item.subject || "").toLowerCase() === subjectFilter;
          });

        if (!filtered.length) {
          if (subjectFilter) {
            list.innerHTML = `<p>No history found for subject <strong>${escapeHtml(queryParams.subject)}</strong>.</p>`;
          } else {
            list.innerHTML = "<p>No history found.</p>";
          }
          return;
        }

        filtered.forEach((item, displayIndex) => {
          const div = document.createElement("div");
          div.className = "history-entry";
          // Note: use item._origIdx for operations (delete/resume)
          div.innerHTML = `
            <strong>${displayIndex + 1}. Topic: ${escapeHtml(item.topic || "")}</strong>
            <div class="dpp-info">
              <div><span>Class:</span> ${escapeHtml(item.classVal || "")}</div>
              <div><span>Subject:</span> ${escapeHtml(item.subject || "")}</div>
              <div><span>Difficulty:</span> ${escapeHtml(item.difficulty || "")}</div>
            </div>
            <small>${escapeHtml(item.date || "")}</small>
            <div class="history-actions">
              <button class="resume" onclick="resumeHistory(${item._origIdx})">üîÑ Resume</button>
              <button class="delete" onclick="deleteHistory(${item._origIdx})">üóëÔ∏è Delete</button>
            </div>
          `;
          list.appendChild(div);
        });
      }

      function showTab(tab) {
        document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        if (tab === "history") {
          document.getElementById("generatorContainer").style.display = "none";
          document.getElementById("historyContainer").style.display = "block";
          document.querySelector(".tab:nth-child(2)").classList.add("active");
          loadHistory();
        } else {
          document.getElementById("generatorContainer").style.display = "block";
          document.getElementById("historyContainer").style.display = "none";
          document.querySelector(".tab:nth-child(1)").classList.add("active");
        }
      }

      function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    </script>
  </body>
</html>


